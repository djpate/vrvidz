<script>
  // Helper: Formats seconds into MM:SS
  function formatTime(time) {
    const minutes = Math.floor(time / 60);
    const seconds = Math.floor(time % 60);
    return (minutes < 10 ? '0' + minutes : minutes) + ':' + 
            (seconds < 10 ? '0' + seconds : seconds);
  }

  AFRAME.registerComponent('video-controls', {
    schema: {
      video: { type: 'selector' },
      hand: { type: 'selector' } // We will pass the controller in here
    },
    init: function () {
      const video = this.data.video;
      const playBtn = this.el.querySelector('.play-btn');
      const playBtnText = this.el.querySelector('.play-btn-text');
      const progressBar = this.el.querySelector('.progress-bar');
      const seekHitbox = this.el.querySelector('.seek-hitbox');
      const timeElapsed = this.el.querySelector('.time-elapsed');
      const timeRemaining = this.el.querySelector('.time-remaining');
      
      // MOVEMENT TRACKING VARIABLES
      this.timer = 0;
      this.lastPosition = new THREE.Vector3();
      this.lastRotation = new THREE.Quaternion();
      // We track the camera as a fallback for desktop testing
      this.camera = document.querySelector('a-camera');

      // 1. PLAY/PAUSE
      playBtn.addEventListener('click', () => {
        if (video.paused) {
          video.play();
          playBtnText.setAttribute('value', 'PAUSE');
        } else {
          video.pause();
          playBtnText.setAttribute('value', 'PLAY');
        }
      });

      // 2. SEEK LOGIC
      seekHitbox.addEventListener('click', (e) => {
        const point = e.detail.intersection.point;
        const objectPosition = seekHitbox.object3D.getWorldPosition(new THREE.Vector3());
        const localX = point.x - objectPosition.x;
        const clickPercent = (localX + 1.5) / 3;
        const clampedPercent = Math.max(0, Math.min(1, clickPercent));
        if (video.duration) {
          video.currentTime = clampedPercent * video.duration;
        }
      });

      // 3. MAIN LOOP (Runs 90 times per second)
     this.tick = function (t, dt) {
        // --- A. INTELLIGENT TRACKING SWITCHER ---
        // default to Camera (for desktop mouse testing)
        let tracker = this.camera.object3D; 
        
        // If we are in VR Mode and the Hand is loaded, switch to Hand tracking
        // We check if the scene is in 'vr-mode' (user clicked the goggles button)
        if (this.el.sceneEl.is('vr-mode') && this.data.hand && this.data.hand.object3D) {
            tracker = this.data.hand.object3D;
        }

        const currentPos = tracker.position;
        const currentRot = tracker.quaternion;

        // Calculate how much we moved/rotated
        const dist = currentPos.distanceTo(this.lastPosition);
        const rotDiff = currentRot.angleTo(this.lastRotation);

        // --- B. THRESHOLD LOGIC ---
        // We use a slightly higher threshold (0.002) to filter out "jitter" from human hands
        if (dist > 0.002 || rotDiff > 0.002) {
            // MOVEMENT DETECTED
            this.timer = 0;
            this.el.setAttribute('visible', 'true');
            this.lastPosition.copy(currentPos);
            this.lastRotation.copy(currentRot);
        } else {
            // STILLNESS DETECTED
            this.timer += dt;
            if (this.timer > 3000 && this.el.getAttribute('visible')) {
              this.el.setAttribute('visible', 'false');
            }
        }

        // --- C. VIDEO UPDATE (Same as before) ---
        if (video.duration) {
          const percent = video.currentTime / video.duration;
          progressBar.setAttribute('scale', `${percent} 1 1`);
          const newX = -1.5 + (1.5 * percent);
          progressBar.setAttribute('position', `${newX} 0 0.02`);

          const currStr = formatTime(video.currentTime);
          const remStr = "-" + formatTime(video.duration - video.currentTime);
          
          if (timeElapsed.getAttribute('value') !== currStr) {
            timeElapsed.setAttribute('value', currStr);
            timeRemaining.setAttribute('value', remStr);
          }
        }
      }
    }
  });
</script>
<a-scene>
  <a-assets>
    <video id="my-video" 
            src="/videos/<%= @filename %>"
            crossorigin="anonymous" loop="true"></video>
  </a-assets>

  <a-videosphere src="#my-video" rotation="0 -90 0"></a-videosphere>

  <a-entity video-controls="video: #my-video" position="0 1.3 -2" rotation="-15 0 0">

    <a-box class="back-btn" 
            width="0.5" height="0.5" depth="0.05"
            material="color: #222; opacity: 0.8; transparent: true; roughness: 0.2"
            position="-1.25 0.6 0">
            <a-text value="<" font="kelsonsans" align="center" width="5" color="#FFFFFF" position="0 0.02 0.06"></a-text>
    </a-box>
    
    <a-box class="play-btn" 
            width="1.2" height="0.5" depth="0.05"
            material="color: #222; opacity: 0.8; transparent: true; roughness: 0.2"
            position="0 0.6 0">
            
            <a-text class="play-btn-text"
                      value="PLAY"
                      font="kelsonsans"
                      align="center"
                      width="1.1"
                      wrap-count="14"
                      color="#FFFFFF"
                      position="0 0 0.06"
                      transparent="false"
                      alpha-test="0.5">
            </a-text>
    </a-box>

    <a-box class="seek-bar-bg"
              width="3" height="0.3" depth="0.03"
              material="color: #222; opacity: 0.5; transparent: true"
              position="0 0 0">
    </a-box>

    <a-box class="progress-bar"
              width="3" height="0.3" depth="0.03"
              material="color: #00e5ff; opacity: 0.9; transparent: true; emissive: #00e5ff; emissiveIntensity: 0.4"
              position="-1.5 0 0.02"
              scale="0 1 1">
    </a-box>

    <a-box class="seek-hitbox"
            width="3" height="0.35" depth="0.01"
            material="opacity: 0; transparent: true"
            position="0 0 0.05">
    </a-box>

    <a-text class="time-elapsed"
            value="00:00"
            font="kelsonsans"
            color="#CCC"
            width="1.8"
            position="-1.5 -0.25 0"
            align="left">
    </a-text>

    <a-text class="time-remaining"
            value="-00:00"
            font="kelsonsans"
            color="#CCC"
            width="1.8"
            position="1.5 -0.25 0"
            align="right">
    </a-text>
    
  </a-entity>

  <a-entity id="rig">
    <a-camera><a-cursor></a-cursor></a-camera>
    <a-entity laser-controls="hand: right" id='my-hand'></a-entity>
  </a-entity>

</a-scene>