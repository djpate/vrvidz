<script>
  // Helper: Formats seconds into MM:SS
  function formatTime(time) {
    const minutes = Math.floor(time / 60);
    const seconds = Math.floor(time % 60);
    return (minutes < 10 ? '0' + minutes : minutes) + ':' + 
            (seconds < 10 ? '0' + seconds : seconds);
  }

  AFRAME.registerComponent('seek-preview', {
    schema: {
      previewCount: { type: 'int' },
    },

    init: function () {
      this.previewImage = this.el;
      this.previewImage.setAttribute('visible', false);
      this.texture = null;

      this.el.addEventListener('materialtextureloaded', () => {
        const mesh = this.el.getObject3D('mesh');
        if (!mesh || !mesh.material || !mesh.material.map) { return; }
        this.texture = mesh.material.map;

        this.texture.wrapS = THREE.RepeatWrapping;
        this.texture.repeat.set(1 / this.data.previewCount, 1);
      });
    },

    showPreview: function (event) {
      if (!this.texture) { return; }

      const point = event.detail.intersection.point;
      const objectPosition = event.target.object3D.getWorldPosition(new THREE.Vector3());
      const localX = point.x - objectPosition.x;
      const hoverPercent = (localX + 1.5) / 3;
      const clampedPercent = Math.max(0, Math.min(1, hoverPercent));

      const previewIndex = Math.floor(clampedPercent * this.data.previewCount);
      
      this.texture.offset.x = previewIndex / this.data.previewCount;
      
      this.previewImage.setAttribute('visible', true);
      
      const newX = -1.5 + (3 * clampedPercent);
      this.previewImage.setAttribute('position', { x: newX, y: 0.35, z: 0.05 });
    },

    hidePreview: function () {
      this.previewImage.setAttribute('visible', false);
    }
  });

  AFRAME.registerComponent('video-controls', {
    schema: {
      video: { type: 'selector' },
      hand: { type: 'selector' } // We will pass the controller in here
    },
    init: function () {
      const video = this.data.video;
      const playBtn = this.el.querySelector('.play-btn');
      const backBtn = this.el.querySelector('.back-btn');
      const playBtnText = this.el.querySelector('.play-btn-text');
      const progressBar = this.el.querySelector('.progress-bar');
      const seekHitbox = this.el.querySelector('.seek-hitbox');
      const timeElapsed = this.el.querySelector('.time-elapsed');
      const timeRemaining = this.el.querySelector('.time-remaining');
      const seekPreview = this.el.querySelector('#seek-preview-image')?.components['seek-preview'];

      this.isHoveringSeekbar = false;

      // BACK BUTTON LOGIC
      backBtn.addEventListener('click', () => {
        window.location.href = "<%= gallery_path %>";
      });
      
      // MOVEMENT TRACKING VARIABLES
      this.timer = 0;
      this.lastPosition = new THREE.Vector3();
      this.lastRotation = new THREE.Quaternion();
      // We track the camera as a fallback for desktop testing
      this.camera = document.querySelector('a-camera');

      // 1. PLAY/PAUSE
      playBtn.addEventListener('click', () => {
        if (video.paused) {
          video.play();
          playBtnText.setAttribute('value', 'PAUSE');
        } else {
          video.pause();
          playBtnText.setAttribute('value', 'PLAY');
        }
      });

      // 2. SEEK LOGIC
      seekHitbox.addEventListener('click', (e) => {
        const point = e.detail.intersection.point;
        const objectPosition = seekHitbox.object3D.getWorldPosition(new THREE.Vector3());
        const localX = point.x - objectPosition.x;
        const clickPercent = (localX + 1.5) / 3;
        const clampedPercent = Math.max(0, Math.min(1, clickPercent));
        if (video.duration) {
          video.currentTime = clampedPercent * video.duration;
        }
      });

      if (seekPreview) {
        seekHitbox.addEventListener('mouseenter', (e) => {
          this.isHoveringSeekbar = true;
        });
        seekHitbox.addEventListener('mouseleave', () => {
          this.isHoveringSeekbar = false;
          seekPreview.hidePreview();
        });
      }

      // 3. STAR RATING LOGIC
      const starBoxes = this.el.querySelectorAll('.star-box');
      starBoxes.forEach((starBox) => {
        starBox.addEventListener('click', (e) => {
          const rating = parseInt(starBox.getAttribute('data-star'));
          this.updateStarRating(rating);
        });

        starBox.addEventListener('mouseenter', () => {
          const rating = parseInt(starBox.getAttribute('data-star'));
          this.highlightStars(rating);
        });

        starBox.addEventListener('mouseleave', () => {
          const currentRating = this.getCurrentRating();
          this.highlightStars(currentRating);
        });
      });

      this.updateStarRating = function(rating) {
        // Update visuals immediately
        this.highlightStars(rating);

        // Save to server
        const videoId = '<%= @video.checksum %>';
        fetch(`/vids/${videoId}/rate`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
          },
          body: JSON.stringify({ rating })
        }).catch(error => console.error('Error saving rating:', error));
      };

      this.highlightStars = function(rating) {
        starBoxes.forEach((starBox, index) => {
          const starNumber = index + 1;
          const starText = starBox.querySelector('a-text');

          if (starNumber <= rating) {
            starBox.setAttribute('material', 'color: #FFD700; opacity: 0.9; transparent: true');
            starText.setAttribute('color', '#FFD700');
          } else {
            starBox.setAttribute('material', 'color: #444; opacity: 0.9; transparent: true');
            starText.setAttribute('color', '#888');
          }
        });
      };

      this.getCurrentRating = function() {
        return <%= @video.rating || 0 %>;
      };

      // 4. MAIN LOOP (Runs 90 times per second)
     this.tick = function (t, dt) {
        // --- A. INTELLIGENT TRACKING SWITCHER ---
        // default to Camera (for desktop mouse testing)
        let tracker = this.camera.object3D; 
        
        // If we are in VR Mode and the Hand is loaded, switch to Hand tracking
        // We check if the scene is in 'vr-mode' (user clicked the goggles button)
        if (this.el.sceneEl.is('vr-mode') && this.data.hand && this.data.hand.object3D) {
            tracker = this.data.hand.object3D;
        }

        const currentPos = tracker.position;
        const currentRot = tracker.quaternion;

        // Calculate how much we moved/rotated
        const dist = currentPos.distanceTo(this.lastPosition);
        const rotDiff = currentRot.angleTo(this.lastRotation);

        // --- B. THRESHOLD LOGIC ---
        // We use a slightly higher threshold (0.002) to filter out "jitter" from human hands
        if (dist > 0.002 || rotDiff > 0.002) {
            // MOVEMENT DETECTED
            this.timer = 0;
            this.el.setAttribute('visible', 'true');
            this.lastPosition.copy(currentPos);
            this.lastRotation.copy(currentRot);
        } else {
            // STILLNESS DETECTED
            this.timer += dt;
            if (this.timer > 3000 && this.el.getAttribute('visible')) {
              this.el.setAttribute('visible', 'false');
            }
        }

        // --- C. VIDEO UPDATE (Same as before) ---
        if (video.duration) {
          const percent = video.currentTime / video.duration;
          progressBar.setAttribute('scale', `${percent} 1 1`);
          const newX = -1.5 + (1.5 * percent);
          progressBar.setAttribute('position', `${newX} 0 0.02`);

          const currStr = formatTime(video.currentTime);
          const remStr = "-" + formatTime(video.duration - video.currentTime);
          
          if (timeElapsed.getAttribute('value') !== currStr) {
            timeElapsed.setAttribute('value', currStr);
            timeRemaining.setAttribute('value', remStr);
          }
        }
        
        // --- D. SEEK PREVIEW UPDATE ---
        if (this.isHoveringSeekbar && seekPreview) {
          const raycasterEl = this.el.sceneEl.querySelector('[raycaster]');
          const raycaster = raycasterEl.components.raycaster;
          const intersection = raycaster.getIntersection(seekHitbox);
          if (intersection) {
            seekPreview.showPreview({ detail: { intersection: intersection } , target: seekHitbox });
          }
        }
      }
    }
  });
</script>
<a-scene>
  <a-assets>
    <video id="my-video" 
            src="/videos/<%= @video.filename %>"
            crossorigin="anonymous" loop="true"></video>
    <% if @video.previews.any? %>
      <img id="preview-sprite" src="/videos/<%= @video.previews.first.filename %>">
    <% end %>
  </a-assets>

  <a-videosphere src="#my-video" rotation="0 -90 0"></a-videosphere>

  <a-entity video-controls="video: #my-video" position="0 1.3 -2" rotation="-15 0 0">

    <a-box class="back-btn" 
            width="0.5" height="0.5" depth="0.05"
            material="color: #222; opacity: 0.8; transparent: true; roughness: 0.2"
            position="-1.25 0.6 0">
            <a-text value="<" font="kelsonsans" align="center" width="5" color="#FFFFFF" position="0 0.02 0.06"></a-text>
    </a-box>
    
    <a-box class="play-btn" 
            width="1.2" height="0.5" depth="0.05"
            material="color: #222; opacity: 0.8; transparent: true; roughness: 0.2"
            position="0 0.6 0">
            
            <a-text class="play-btn-text"
                      value="PLAY"
                      font="kelsonsans"
                      align="center"
                      width="1.1"
                      wrap-count="14"
                      color="#FFFFFF"
                      position="0 0 0.06"
                      transparent="false"
                      alpha-test="0.5">
            </a-text>
    </a-box>

    <a-box class="seek-bar-bg"
              width="3" height="0.3" depth="0.03"
              material="color: #222; opacity: 0.5; transparent: true"
              position="0 0 0">
    </a-box>

    <a-box class="progress-bar"
              width="3" height="0.3" depth="0.03"
              material="color: #00e5ff; opacity: 0.9; transparent: true; emissive: #00e5ff; emissiveIntensity: 0.4"
              position="-1.5 0 0.02"
              scale="0 1 1">
    </a-box>

    <a-box class="seek-hitbox"
            width="3" height="0.35" depth="0.01"
            material="opacity: 0; transparent: true"
            position="0 0 0.05">
    </a-box>

    <% if @video.previews.any? %>
      <% preview = @video.previews.first %>
      <a-image id="seek-preview-image"
               width="0.4" height="0.225"
               material="shader: flat; src: #preview-sprite;"
               seek-preview='previewCount: <%= preview.count %>;'>
      </a-image>
    <% end %>

    <a-text class="time-elapsed"
            value="00:00"
            font="kelsonsans"
            color="#CCC"
            width="1.8"
            position="-1.5 -0.25 0"
            align="left">
    </a-text>

    <a-text class="time-remaining"
            value="-00:00"
            font="kelsonsans"
            color="#CCC"
            width="1.8"
            position="1.5 -0.25 0"
            align="right">
    </a-text>

    <!-- Star Rating -->
    <a-entity class="star-rating-vr" position="0 -0.7 0">
      <% (1..5).each_with_index do |star, index| %>
        <a-box class="star-box"
               data-star="<%= star %>"
               width="0.15" height="0.15" depth="0.05"
               material="color: <%= @video.rating && @video.rating >= star ? '#FFD700' : '#444' %>; opacity: 0.9; transparent: true"
               position="<%= -0.4 + (index * 0.2) %> 0 0">
          <a-text value="â˜…"
                  font="kelsonsans"
                  align="center"
                  width="3"
                  color="<%= @video.rating && @video.rating >= star ? '#FFD700' : '#888' %>"
                  position="0 0 0.06"></a-text>
        </a-box>
      <% end %>
    </a-entity>
    
  </a-entity>

  <a-entity id="rig">
    <a-camera><a-cursor></a-cursor></a-camera>
    <a-entity laser-controls="hand: right" id='my-hand'></a-entity>
  </a-entity>

</a-scene>